var isRepoExit = require('./lib/isrepoexit');
var clone = require('./lib/clone');
var emptyDir = require('./lib/empty');
var commit = require('./lib/commit');
var update = require('./lib/update');
var fse = require('fs-extra');
var fs = require('fs');
var chalk = require('chalk');

module.exports = function(options) {
    // 默认分支master
    var branch = options.branch;
    // build 目录
    var build = options.build;
    // 发布目录
    var deploy = options.deploy;
    // git 地址
    var repo = options.repo;

    //是否需要清空目录
    var empty = options.empty === false ? false : true;

    console.log(chalk.green('deploy: [' + deploy + ']'));
    console.log(chalk.green('repo: [' + repo + ']'));

    // check options
    if(!fs.existsSync(build)) {
    	console.log(chalk.red('options.build: [' + build + '] not existed.'));
    	return -1;
    }

    // init repo
    if (!isRepoExit(deploy)) {
    	console.log(chalk.gray('------ repo not existed ------'));
    	// remove
    	fse.removeSync(deploy);
        fse.ensureDirSync(deploy);
        // clone if not existed
        clone(repo, deploy);
    } else {
    	console.log(chalk.gray('------ repo existed ------'));
    }
    // update to branch
    update(deploy, branch);

    if(empty){
        // 删除一些目录
        console.log(chalk.gray('empty dir: [' + deploy + ']'));
        emptyDir(deploy);
    }
    else{
        console.log('do not empty dir');
    }


    console.log(chalk.gray('copy dir: [' + build + '] -> [' + deploy + ']'));
    // copy to deploy
    fse.copySync(build, deploy, {clobber: true});

    commit(deploy, branch);

}
